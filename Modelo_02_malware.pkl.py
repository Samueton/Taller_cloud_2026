import pickle
import numpy as np
import pandas as pd

# 1. Cargar el archivo que contiene todos los objetos del entrenamiento
try:
    with open('pipeline_malware.pkl', 'rb') as f:
        objetos = pickle.load(f)
    
    # Extraemos cada pieza del rompecabezas
    modelo = objetos['modelo_final']
    scaler = objetos['scaler']
    pca = objetos['pca']
    imputer = objetos['imputer']
    le = objetos['label_encoder']
    
    print("✓ Modelo y componentes cargados correctamente.\n")
except FileNotFoundError:
    print("Error: No se encontró el archivo 'pipeline_malware.pkl'.")
    exit()
except KeyError as e:
    print(f"Error: El archivo .pkl no contiene la llave esperada: {e}")
    exit()

# 2. Lista de características (Las 14 que seleccionaste en el entrenamiento)
columnas = [
    'Flow Duration', 'Total Fwd Packets', 'Total Backward Packets', 
    'Total Length of Fwd Packets', 'Fwd Packet Length Max', 
    'Fwd Packet Length Min', 'Fwd Packet Length Mean', 'Flow Bytes/s', 
    'Flow Packets/s', 'Flow IAT Mean', 'Fwd IAT Total', 
    'Bwd IAT Total', 'Active Mean', 'Idle Mean'
]

# 3. Captura de datos del usuario
valores_usuario = []
print("--- TEST DE TRÁFICO DE RED (DETECCIÓN DE MALWARE) ---")
print("Ingrese los valores numéricos solicitados:")

for columna in columnas:
    while True:
        try:
            dato = input(f"{columna}: ")
            valores_usuario.append(float(dato))
            break
        except ValueError:
            print("  [!] Entrada inválida. Ingrese un número válido.")

# 4. PROCESAMIENTO DE LOS DATOS (El mismo flujo que el entrenamiento)

# Crear el DataFrame con los nombres de columnas
nueva_muestra = pd.DataFrame([valores_usuario], columns=columnas)

# PASO A: Limpiar nulos (Imputer)
nueva_muestra_imputed = imputer.transform(nueva_muestra)

# PASO B: Escalar los datos (Scaler)
nueva_muestra_scaled = scaler.transform(nueva_muestra_imputed)

# PASO C: Reducir dimensiones (PCA)
# Este paso es el que faltaba y es fundamental porque el modelo RF espera la salida del PCA
nueva_muestra_pca = pca.transform(nueva_muestra_scaled)

# 5. PREDICCIÓN FINAL
prediccion_numerica = modelo.predict(nueva_muestra_pca)[0]
probabilidades = modelo.predict_proba(nueva_muestra_pca)[0]

# Convertir el número (0 o 1) al nombre original (ej: 'Malware' o 'Benign')
resultado_nombre = le.inverse_transform([prediccion_numerica])[0]

# 6. MOSTRAR RESULTADOS
print("\n" + "="*45)
print(" RESULTADO DEL ANÁLISIS")
print("="*45)
print(f"Clasificación final: {resultado_nombre}")

# Si la clase 1 es Malware, mostramos esa probabilidad
# En RF multiclase o binario, buscamos el índice de la clase detectada
prob_final = probabilidades[prediccion_numerica] * 100

print(f"Confianza de la predicción: {prob_final:.2f}%")

if prediccion_numerica == 1:
    print("\n[ALERTA] Se recomienda bloquear este flujo de red inmediatamente.")
else:
    print("\n[INFO] El flujo de datos parece ser seguro.")
print("="*45)